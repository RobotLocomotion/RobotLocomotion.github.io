<!-- HTML header for doxygen 1.15.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Drake: Margin for Hydroelastic Contact</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<header class="site-header">
 <div class="site-header-inner contain">
  <a class="drake-logo" href="/"><img src="/images/drake-logo-white.svg"></a>
  <div class="menu-mobile-toggle">
   <span></span>
  </div>
  <nav class="site-menu">
   <ul>
    <li class="site-menu-item site-menu-item-main">
     <a class="site-menu-item" href="/">Home</a>
    </li>
    <li class="site-menu-item site-menu-item-main">
     <a class="site-menu-item" href="/installation.html">Installation</a>
    </li>
    <li class="site-menu-item site-menu-item-main">
     <a class="site-menu-item" href="/gallery.html">Gallery</a>
    </li>
    <li class="site-menu-item site-menu-item-main">API Documentation
     <div class="sub">
      <a class="site-menu-item" href="/doxygen_cxx/index.html">C++</a>
      <a class="site-menu-item" href="/pydrake/index.html">Python</a>
     </div>
    </li>
    <li class="site-menu-item site-menu-item-main">Resources
     <div class="sub">
      <a class="site-menu-item" href="/getting_help.html">Getting Help</a>
      <a class="site-menu-item" href="https://deepnote.com/workspace/Drake-0b3b2c53-a7ad-441b-80f8-bf8350752305/project/Tutorials-2b4fc509-aef2-417d-a40d-6071dfed9199/notebook/index-753e3c9d261247ba9f0eb1d7868c18c8">Tutorials</a>
      <a class="site-menu-item" href="/python_bindings.html">Python Bindings</a>
      <a class="site-menu-item" href="/developers.html">For Developers</a>
      <a class="site-menu-item" href="/credits.html">Credits</a>
     </div>
    </li>
    <li class="github-link">
     <a class="site-menu-item" href="https://github.com/RobotLocomotion/drake">GitHub <img src="/third_party/images/GitHub-Mark-Light-64px.png"></a>
    </li>
   </ul>
  </nav>
 </div>
</header>
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Drake
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<div class="title-banner">
 <div class="title-banner__title">
  Drake C++ Documentation
 </div>
 <div id="DDGSearch">
  <form id="search_form_cpp" class="wy_form" action="https://google.com/search" method="get">
   <input type="text" name="q" placeholder="Search C++ API only…">
   <input type="hidden" name="q" value="site:drake.mit.edu/doxygen_cxx">
  </form>
  <form id="search_form" class="wy_form" action="https://google.com/search" method="get">
   <input type="text" name="q" placeholder="Search all of Drake…">
   <input type="hidden" name="q" value="site:drake.mit.edu OR site:underactuated.csail.mit.edu OR site:manipulation.csail.mit.edu">
  </form>
 </div>
 <div id="MSearchBoxContainer">
  <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('group__hydro__margin.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Margin for Hydroelastic Contact <div class="ingroups"><a class="el" href="group__multibody.html">Multibody Kinematics and Dynamics</a> &raquo; <a class="el" href="group__drake__contacts.html">Contact Modeling in Drake</a></div></div></div>
</div><!--header-->
<div class="contents">
<p>In Drake, multibody systems with frictional contact are simulated via a discrete approximation, see <a class="el" href="group__mbp__discrete.html">Discrete Models for Simulation</a> (while Drake also offers <a class="el" href="group__mbp__continuous.html">Continuous Models for Simulation</a>, currently the discrete approximation performs best.) The accuracy of these discrete approximations depends on the selected time step size <span class="tt">h</span>. Moreover, at large enough time steps, instability problems can arise leading to unphysical intermittent contact.</p>
<p>To mitigate these instability problems, we introduce the concept of "margin". While margin is not a new concept (<a class="el" href="group__drake__contacts.html#Catto2013">[Catto, 2013]</a>), the way margin is used in Drake differs from its traditional purpose in game engines. Game engines such as Bullet (<a class="el" href="group__drake__contacts.html#BulletSdkManual">[Coumans, 2015; §4]</a>) and <a href="https://docs.unity3d.com/2023.2/Documentation/Manual/speculative-ccd.html">Unity</a> introduce margin mostly as a mechanism to mitigate pass through problems that can arise when objects move at high speeds and/or the simulation time step sizes are large in order to meet real-time requirements within a limited computational budget. In Drake however, margin is used to mitigate instability problems inherent to discrete schemes with a fixed time step size.</p>
<dl class="section note"><dt>Note</dt><dd>As mentioned, the concepts of margin and speculative constraints discussed below are not new. What is new and unique to Drake, is the extension of these ideas to <a class="el" href="group__compliant__contact.html#hydro_contact">Hydroelastic Contact</a>.</dd>
<dd>
Margin in Drake is a concept that only applies to <a class="el" href="group__compliant__contact.html#hydro_contact">Hydroelastic Contact</a>.</dd></dl>
<p>In the following sections we describe why we introduce margin, how we do it, and its limitations.</p>
<h1 class="doxsection"><a class="anchor" id="discrete_contact_instabilities"></a>
Discrete Contact Instabilities</h1>
<p>We motivate the concept of margin by considering an instability problem with the simulation in Fig. 1. Two boxes (of 0.2 m x 0.15 m x 0.08 m and mass of 0.2 kg) are stacked on top of each other. Their dynamics is simulated at a relatively large time step of 10 ms (large for robotics applications). Only their surface meshes are shown as wire frames so that we can appreciate the contact surface, colored by pressure. While we'd expect the upper box to rest stably on the lower box, we observe a wobbling instability where the contact surface shifts back and forth between two corners.</p>
<div class="image">
<img src="unstable_box_box_contact.gif" alt="" width="50%"/>
<div class="caption">
Figure 1: Unstable flat-on-flat contact.</div></div>
<p>This wobbling is not physical, but rather a numerical instability. To gain insight into this problem, we analyze the simplified system in Fig. 2. In this case, contact takes place between a single box and a ground plane in 2D. In Fig. 2, we see the box at three consecutive time steps, labeled tₙ, tₙ₊₁, and, tₙ₊₂. In this simplified system, we've also simplified the contact model to a point contact model in which only the corners marked in red can make contact with the ground. At time tₙ only the left corner is in penetration. For such a configuration the contact resolution phase will predict a contact force that will attempt to minimize this interpenetration. If the time step size is large enough, the box's configuration can actually overshoot into the state sketched for tₙ₊₁. Now the box is in a new state where the right corner is in contact and the left corner is out of contact. In this configuration, the box can overshoot once again to the state at tₙ₊₂. Even more, the motion of the box can fall into a limit cycle with oscillating contact between the two corners.</p>
<p>The situation is more complex in Fig. 1, but the same underlying principle applies.</p>
<div class="image">
<img src="discrete_instabilities.png" alt="" width="35%"/>
<div class="caption">
Figure 2: Oscillating contact results in wobbling instabilities.</div></div>
<p>The instability arises when the stable contact between two object has a large cross-sectional area on a plane (i.e., it really doesn't happen between spheres and planes). Figure 3 shows an example of this instability for the contact between a mug placed on top of a plate. When the visuals for the geometries are turned off, we can see the two contact surfaces (table/plate and plate/table) rocking back and forth. The visualization also includes the contact forces (red) and moments (blue). In both contacts, the table contact surface is a large, flat circular patch. Even if the mug had an extruded rim on its bottom, the stable contact would be a large, planar ring-like patch, exhibiting the same behavior.</p>
<div class="image">
<img src="mug_on_plate.gif" alt="" width="50%"/>
<div class="caption">
Figure 3: Instability on complex geometries. Mug on a plate.</div></div>
<h1 class="doxsection"><a class="anchor" id="speculative_constraints"></a>
Speculative Contact Constraints</h1>
<p>Lets consider once again the schematic in Fig. 2. At each time step, the solver only adds one constraint for each reported contact point (left or right). Satisfying this single constraint can lead to unbounded "correction". If, instead, the set of contact constraints is augmented to include both points &ndash; a point in contact and a point nearly in contact &ndash; the solver can now use this additional information to compute a force that can avoid the overshooting that leads to the instability. We are essentially adding contact constraints before contact actually happens. Whether these constraints become active or not, will ultimately depend on the contact resolution phase, which considers balance of momentum and the physics of contact. We refer to this new set of constraints as "speculative contact constraints", <a class="el" href="group__drake__contacts.html#Catto2013">[Catto, 2013]</a>. Speculative constraints are highlighted with blue boxes in Fig. 2.</p>
<p>To provide more context, we'll discuss briefly how the solver can use information from speculative constraints. Each contact pair will be associated with a signed distance ϕ (defined negative if objects overlap). For a compliant point contact (we discuss hydroelastic contact below) with stiffness k (we can ignore dissipation for this discussion), the normal force is modeled according to <span class="tt">fₙ = k (-ϕ)₊</span>, where (a)₊ = max(0, a). Notice that fₙ ≥ 0 (i.e. repulsive) always. At each time step Drake's geometry engine is invoked to compute all contact pairs at the (current) time step before contact resolution takes place (where a solver uses physics to determine the next state). Without margin, the geometry engine only reports contact pairs of geometry in penetration, with signed distances ϕ₀ &lt; 0 (penetration) at the current time step, before contact resolution. To estimate the signed distance function ϕ (from ϕ₀) at the next state, Drake's solvers use a first order approximation as ϕ ≈ ϕ₀ + h⋅vₙ, where ϕ₀ is the signed distance at the current time step, vₙ the normal component of the (next time step) relative velocity between the two participating bodies at the contact point and h is the time step size. Using this approximation for each of the contact pairs reported by the geometry engine, Drake solvers set constraints to model the contact force as </p><pre>
  fₙ ≈ k (-ϕ₀ - h⋅vₙ)₊,  ϕ₀ &lt; 0,                                           (1)
</pre><p> where condition ϕ₀ &lt; 0 is actually implicit by the fact that the geometry engine only reports pairs in penetration, with ϕ₀ &lt; 0. System velocities, along with normal velocities <span class="tt">vₙ</span> in (1) are unknown. These are determined during the contact resolution phase along with the contact forces that satisfy the equations of motion.</p>
<p>To include speculative constraints, we need to allow the geometry engine to report pairs with ϕ₀ &gt; 0 (i.e. before contact happens, as in the blue boxes in Fig. 2). To be thorough, we'd include all geometry pairs that might possibly make contact in the next time step, no matter how long distances ϕ₀ at the current step might be. However, there are good reasons to limit the set of speculative constraints:</p><ol type="1">
<li>Given distance ϕ₀ and relative velocity, most pairs will not make contact within the next time step.</li>
<li>The linear approximation ϕ ≈ ϕ₀ + h⋅vₙ starts losing accuracy the farther points are.</li>
</ol>
<p>Therefore speculative constraints between distant points are generally useless. Moreover, we'd be paying a higher O(n²) computational cost to compute and track this useless information.</p>
<p>Therefore, in practice we ask for a subset that only contains geometry pairs within a <em>margin</em> distance δ. That is, we set constraints to model forces as: </p><pre>
  fₙ ≈ k (-ϕ₀ - h⋅vₙ)₊,  ϕ₀ &lt; δ,                                           (2)
</pre><p>In the limit to δ = ∞, we'd include all pairs possibly in contact, though at a significant increase of the computational cost due to geometry. With δ = 0, no speculative constraints are considered.</p>
<p>Speculative contact constraints come from finding more "contact" points. When margin is zero, only those points actually in contact are reported. As margin grows, we also need to find points that are outside of contact, but within margin distance of contact. There is an increased computational cost for positive margin values in both finding those additional points as well as handling the constraints that arise from them. Tuned well, the impact of this additional computation can be negligible compared to the benefits of increased stability.</p>
<p>The precise value of margin is therefore determined as a trade-off between accuracy/stability and performance. Section <a class="el" href="#margin_how_much">But How Much Margin?</a> discusses how we determine values of margin in detail.</p>
<dl class="section note"><dt>Note</dt><dd>Margin does not introduce action-at-a-distance effects. The speculative contact constraints only come into play (producing non-zero forces) if the solver finds they would make contact within the discrete time step being solved and the force associated with that point is requisite to the nature of anticipated contact.</dd></dl>
<h1 class="doxsection"><a class="anchor" id="margin_for_hydroelastics"></a>
Hydroelastic Contact</h1>
<p>Speculative contact constraints within a given margin fit well within a framework in terms of distance constraints — contact pairs with a distance within the margin threshold are included in the contact resolution phase. In contrast, how to introduce margin within the hydroelastic contact framework is not as straightforward.</p>
<p>In the <a class="el" href="group__compliant__contact.html#hydro_contact">hydroelastic contact model</a>, each geometry is assigned a body-centric <em>pressure field</em>. The contact surface between two overlapping geometries is computed as the surface of equal hydroelastic pressure. Historically, the pressure field is defined to be zero at the surface of the geometry (no contact implies no contact pressure). Contact surfaces always have non-negative pressure and lay completely within the intersecting volume of the two colliding geometries.</p>
<p>To include the concept of margin, we need to extend the notion of hydroelastic contact to include <em>imminent</em> contact. A contact surface shouldn't be limited to the non-negative region of the pressure field but should extend into the negative region at a distance equal to the margin amount. By doing so, we can extract the necessary point data for introducing speculative constraints.</p>
<p>Extending the contact surface into the negative region can be done a number of ways. We chose an approach that limits the impact on computation. The goal is to increase the extent of the pressure field over which we can find contact surfaces, without increasing the cost of finding the surfaces. To that end, we replace the specified compliant hydroelastic geometry with an alternative representation whose surface is an approximation of the offset surface of the original geometry's surface (extended outward by margin distance). The pressure field defined within this "inflated" geometry is defined such that the zero level set of the pressure field is a good approximation of the original geometry's surface (where reasonably possible, it is an exact reproduction).</p>
<p>It's worth noting that only in a few cases are we truly producing an offset surface (spheres and capsules). For other convex primitives we approximate the offset surface of a shape with a larger shape of the same type. Non-convex shapes require additional consideration and are discussed in further detail in <a class="el" href="#margin_non_convex">Non-Convex Geometries</a>.</p>
<p>Figure 4 exemplifies this process for the case of a cylinder. Iso-surfaces of constant pressure, colored by pressure, are shown. The extended pressure is defined such that the zero pressure level set corresponds to the original cylinder.</p>
<div class="image">
<img src="extended_cylinder.png" alt="" width="35%"/>
<div class="caption">
Figure 4: Inflated cylinder and its pressure field.</div></div>
<p>The newly inflated geometries and their extended pressure fields are then processed as any other hydroelastic fields. When the geometries (including their margin region) overlap, the contact surface is computed as the surface of equal pressure. This computation will now lead to tessellated contact surfaces with a thin "skirt", of thickness in the order of the margin, all around the contact surface where pressures are negative. Figure 5 shows peppers in contact with a blue table surface. The peppers have been modeled with a very large margin value of 1 cm to emphasize this "skirt" of negative pressure values. Normally, the contact surface would, by definition, lie completely within the pepper. Here, we can see the contact surface extending outside the pepper by about the margin distance, showing the negative pressure regime.</p>
<div class="image">
<img src="peppers_margin_1cm.png" alt="" width="30%"/>
<div class="caption">
Figure 5: Pepper models with a very large margin of δ = 1 cm.</div></div>
<p>Similarly to the compliant point contact model in terms of signed distance, we use a first order approximation of the pressure field as p ≈ (p₀ + h⋅vₙ⋅g)₊, where p₀ is the previous time step pressure and g = ∂p/∂n is the gradient of the pressure field in the normal direction (see <a class="el" href="group__hydroelastic__user__guide.html#Masterjohn2022">[Masterjohn et al., 2022]</a>). With this, the normal force contribution from a polygon of area Δ is: </p><pre>
  fₙ = Δ⋅(p₀ + h⋅vₙ⋅g)₊,
</pre><p> where for speculative constraints p₀ &lt; 0.</p>
<p>Therefore, polygons with a negative pressure are processed by the contact solver as speculative constraints, and will only generate forces if the new configuration pushes these polygons into the positive pressure region. Polygons that after the resolution phase still have a negative pressure will not produce forces. As with the example of Fig. 5, the margin layer effectively increases the number of constraints, increasing the contact problem size.</p>
<p>For more on hydroelastic contact, including the modeling of dissipation, refer to <a class="el" href="group__compliant__contact.html#hydro_contact">Hydroelastic Contact</a>.</p>
<h1 class="doxsection"><a class="anchor" id="margin_how_much"></a>
But How Much Margin?</h1>
<p>How much margin is enough to mitigate stability problems and how does this quantity scale or depend on problem parameters such stiffness, size, etc.?</p>
<p>To answer this question we consider the simplified two-dimensional system in Fig. 6. This is a massless rod of length <span class="tt">L</span> connecting two points of mass <span class="tt">m/2</span>. We assume the rod to be in a limit cycle between two states, State I (shown on the left) and State II (shown on the right). Only one point is in penetration in each state. In the discrete setting, the rod is assumed to go back and forth between these two states in a single time step. The states are assumed symmetric, with the rod rotated an angle θ in State I and an angle -θ in State II. Due to this symmetry, the angular velocity to go from State II to State I is ω and the angular velocity to go from State I to State II is -ω. This analysis omits dissipation, but we believe the conclusions are still applicable in the presence of dissipation.</p>
<div class="image">
<img src="margin_stability.png" alt="" width="50%"/>
<div class="caption">
Figure 6: Simplified system for stability analysis.</div></div>
<p>Since the system is in this symmetric limit cycle, the rod does not move in the vertical direction. Therefore the mean normal force due to contact must balance gravity, i.e. <span class="tt">&lt;fₙ&gt; = m⋅g</span>. Since only one point is in contact at each state, we have that <span class="tt">&lt;fₙ&gt; = fₙ</span>, where we denoted with fₙ the instantaneous normal force at one of these points. Thus fₙ = m⋅g. Notice this force value is independent of stiffness.</p>
<p>The rotational inertia of this system is <span class="tt">I = m⋅L²/4</span>. In the discrete system, the system moves between State I and State II according to the balance of momentum: </p><pre>
  I⋅(ω − ω₀)=h⋅fₙ⋅L/2,
  θ = θ₀ + h⋅ω,
</pre><p> with θ₀ and ω₀ the previous angle and angular velocity, respectively. Since the states are symmetric, ω₀ = -ω and θ₀ = -θ. Using the expressions for <span class="tt">I</span> and <span class="tt">fₙ</span> we can determine the angular velocity to be <span class="tt">ω = h⋅g/2</span>. The angle is then θ = h²⋅g/(2L). The total angle change is Δθ = 2⋅θ = h²⋅g/L. We can now determine the amplitude of these oscillations in signed distance as Δϕ = L⋅sin(Δθ) ≈ L⋅Δθ. Putting it all together we obtain: </p><pre>
  Δϕ = h²⋅g.                                                               (3)
</pre><p>This result reveals a number of important properties for the amplitude of these oscillations:</p><ol type="1">
<li>independent of mass m and of size L,</li>
<li>independent of contact stiffness k,</li>
<li>scale with h²,</li>
</ol>
<p>This is a very important result, because if it holds for more complex and arbitrary geometries, it tells us that we can use a single value of the margin δ for all of our simulations (for as long as we are on the same planet).</p>
<dl class="section note"><dt>Note</dt><dd>The independence of (3) on stiffness is predicated on the assumption that only one of the points is in contact at a given time. As stiffness is decreased, the oscillating rod would essentially <em>sink</em> into the ground. As this happens, both contact points could come into contact at the same time. Eventually, oscillations would no longer persist due to this effect. We observed this to be generally true in more complex systems involving more complex geometries; compliance helps to mitigate these oscillations as more points come into contact, though it may require unphysically low values of compliance.</dd></dl>
<h2 class="doxsection"><a class="anchor" id="margin_its_effect"></a>
The Effect of Margin</h2>
<p>In the analysis of the simple rod system in Fig. 6, we realize that these oscillations can be mitigated completely if at each time step we consider both the left and right contact points when solving the contact problem at each time step. Moreover, the analysis tells us that for more complex systems, it is not really necessary to consider all O(n²) geometry pairs in the scene, but really only those that are within a distance in the order of the estimated amplitude of the vibrations, i.e. O(h²⋅g).</p>
<p>With this in mind, we then expect that if δ = O(h²⋅g), then these spurious oscillations will be mitigated. We verify this idea in the original system of Fig. 1, with a wide range of margin values. To test a very adversarial situation we use E = 10⁹ Pa (as explained above, compliance helps mitigate these instabilities). For each contact constraint we measure the signed distance ϕ and compute its standard deviation σ(|ϕ|) as a metric to characterize the amplitude of these spurious oscillations. Since h² changes several orders of magnitude, and guided by (3), we plot in Fig. 7 the dimensionless amplitude σ(|ϕ|) / (h²⋅g).</p>
<dl class="section note"><dt>Note</dt><dd>Theoretically, for the rod, the dimensionless amplitude σ(|ϕ|) / (h²⋅g) should equal one. For more complex geometries, we do not expect this to be true. However we do expect this quantity to be of <em>order</em> one. This explains why we do not even need a logarithmic scale in Fig. 7 while being a nice confirmation of (3).</dd></dl>
<p>Finally, notice we use <span class="tt">δ / (h²⋅g)</span> for the horizontal axis. This is again guided by (3), which predicts that values of margin δ effective at mitigating oscillations are order h². We observe in Fig. 7 that indeed for <span class="tt">δ / (h²⋅g) ≳ 1</span> the instabilities die off.</p>
<div class="image">
<img src="instability_vs_margin.png" alt="" width="30%"/>
<div class="caption">
Figure 7: Standard deviation of the vibrations vs. margin.</div></div>
<p>Once again, keep in mind that the rod analysis is very simplified. For instance, notice in Fig. 7 that at larger time steps margin δ is more effective yet (requiring only <span class="tt">δ / (h²⋅g) ≳ 0.01</span> for oscillations to die off). This can be explained by the <em>numerical dissipation</em> introduced by discrete schemes, which is not taken into account in our simplified analysis, and goes away as time step is decreased.</p>
<p>Figure 7 indicates that for time steps [10⁻², 10⁻³, 2×10⁻⁴] (seconds) that the oscillation disappeared with δ / (h²⋅g) ≈ [10⁻², 10⁻¹, 10⁻¹], respectively. Given those values, we can solve for margin values of δ = [10⁻⁵, 10⁻⁶, 4×10⁻⁸] (meters), respectively. The worst case comes from the largest margin, 10⁻⁵ m (most expensive computation). To account for factors not included in our analysis, we in general choose the very conservative value of <span class="tt">δ = 10⁻⁴ m</span>. We confirmed the effectiveness of this value over and over again with additional experimentation on more complex systems as those in Figs. 3 and 5. While incredibly effective, notice how small this value is.</p>
<h1 class="doxsection"><a class="anchor" id="margin_contact_results"></a>
Contact Results</h1>
<p>TODO: write.</p>
<h1 class="doxsection"><a class="anchor" id="margin_appendices"></a>
Appendix</h1>
<p>The following sections cover more advanced material not really essential for the general understanding and effective use of margin and speculative contact constraints in Drake. We provide this material for completeness since many advanced users might find it useful.</p>
<h2 class="doxsection"><a class="anchor" id="margin_non_convex"></a>
Non-Convex Geometries</h2>
<p>TODO: Write this.</p>
<h2 class="doxsection"><a class="anchor" id="margin_scaling_confirmation"></a>
Numerical Confirmation of the Scaling Law</h2>
<p>The result in (3) predicts the magnitude of contact oscillations in the absence of margin (δ = 0) for the simplified system of Fig. 6. The estimation predicts <span class="tt">Δϕ = h²⋅g</span>. This estimate will not hold exactly for arbitrary geometries and mass distributions. The expectation, however, is that the scaling <span class="tt">Δϕ ~ h²⋅g</span> still does provide a good estimate of the magnitude of these spurious oscillations.</p>
<p>The aim of this section is to verify to what extent this scaling does provide a good estimate of the amplitude of these oscillations in a more complex case. We are particularly interested not only to understand to what extent the scaling law applies to this system but even more so, to verify the independence of these results with parameters such as stiffness and mass (the simplified case was actually shown to be independent of these parameters). If (3) happens to provide a good estimate, then we have a very good chance of success at choosing a value of margin δ for arbitrary simulation cases.</p>
<p>For a general contact problem, many physical and numerical parameters are involved:</p><ol type="1">
<li>Hydroelastic modulus E.</li>
<li>Mass (or density).</li>
<li>Sizes and aspect ratios.</li>
<li>Shape and mass distribution</li>
<li>Time step.</li>
<li>Hunt &amp; Crossley dissipation.</li>
</ol>
<p>To start somewhere, we fix the shapes we use, and choose as our first study case the stack of boxes we started with, Fig. 1. To verify (3), we'd need to scan this high dimensional space of parameters, a daunting task. To make this tractable we resource the incredibly powerful tool of dimensional analysis. This method reduces the dimension of the parameter space by finding an alternative (smaller) set of dimensionless parameters. The underlying method is described by Buckingham π theorem, though in practice selecting these parameters often requires a great deal of experience and physical intuition. We won't go into detail here, but let's consider a common example in fluid dynamics. While the drag force a fluid exerts on an object is an incredibly complex function of density, viscosity, flow speed, geometry and size, engineers make very useful plots involving two (now very popular) dimensionless quantities: drag coefficient vs. Reynolds number. We therefore use the same procedure to find two dimensionless parameters that can succinctly capture the physics (and numerics in this case) of the problem at hand.</p>
<p>We start by defining an <em>effective spring stiffness</em> as <span class="tt">k = E⋅A/H</span>, with E the hydroelastic modulus, A the area of contact (in our case the area of the base of the box), and H the <em>Elastic Foundation</em> depth (in our case half of the boxes minimum side length). With this, we can define the (angular) frequency <span class="tt">ω =
(k/m)¹ᐟ²</span>, similar to a spring-mass system, where <span class="tt">m</span> is the mass of the box. This frequency characterizes the dynamics of the compliant contact, and our intuition tells us it should be an important quantity in the analysis. With this, we define our first dimensionless parameter: <span class="tt">π₁ = h⋅ω = h⋅(k/m)¹ᐟ²</span>.</p>
<p>Our second parameter must involve the amplitude of the oscillations. Guided by our estimation in (3), we define <span class="tt">π₂ = σ(|ϕ|) / (h²⋅g)</span>, where to characterize the amplitude of the oscillations we measure the standard deviation <span class="tt">σ(|ϕ|)</span> of the penetrations.</p>
<p>Having identified these two dimensionless parameters, we now run a large number of simulations, sampling the parameter space (E, m, sizes, h). We then measure <span class="tt">σ(|ϕ|)</span> for each, compute π₁ and π₂ and plot them with the hope to find a clear relationship among them.</p>
<p>The parameters we sweep are:</p><ol type="1">
<li>Hydroelastic modulus E, from 10⁴ Pa to 10⁹ Pa.</li>
<li>Time step, h ∈ [6.25×10⁻⁴, 1.25×10⁻³, 2.5×10⁻³, 5×10⁻³, 10⁻²], in seconds.</li>
<li>Size. We scale the size by factors of 2 and 4.</li>
<li>Shape. We scale only along the x-axis of the box.</li>
<li>Mass. Density is kept constant, changing accordingly as the size of the box changes.</li>
</ol>
<p>All simulations use a non-zero Hunt &amp; Crossley dissipation <span class="tt">d = 20 s/m</span> to keep the rattling instability somewhat under control to avoid the upper box from drifting and falling to the side.</p>
<p>We plot <span class="tt">σ(|ϕ|) / (h²⋅g)</span> in Fig. 8. Labels correspond to hydroelastic modulus <span class="tt">E</span>, and in parentheses to size and shape changes. The very first thing we observe clearly is that oscillations die off below a frequency close to the Nyquist frequency (= 1/(2h), or h⋅(k/m)¹ᐟ² = π). This makes sense, as the dynamics of contact is resolved by the simulation time step, the numerical method is able to recover from this spurious oscillatory behavior. We note that the increase we observe at the smaller values of <span class="tt">π₁ = h⋅ω</span> is only an artifact of the simulations not reaching yet a steady state; compliance is so low that with the dissipation used boxes are still settling.</p>
<p>Second, we observe that oscillations develop at frequencies higher than the Nyquist frequency; time step is not small enough to resolve the dynamics of the compliant contact. While (3) predicts a constant value in this regime, we observe for this case (dimensionless) amplitudes in the range π₂ ∈ (0.1, 0.6). This might seem like a large discrepancy with the simplified analysis, but it's quite the opposite! Keep in mind this is a significantly more complex system than the one in Fig. 6 and that parameters change order of magnitude over a wide range. Even for this case, estimating the amplitude of these vibrations with ~h²⋅g, provides a good approximation.</p>
<div class="image">
<img src="box_on_box_std_penetration_with_notations.png" alt="" width="35%"/>
<div class="caption">
Figure 8: Amplitude of the oscillations with problem parameters. No margin, δ = 0.</div></div>
 </div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- footer -->
<div class="navpath">
  <ul>
  </ul>
</div>
<footer id="nav-path", class="site-footer padding">
  <div class="contain">
    <a href="/" class="drake-logo">
      <img src="/images/drake-logo.svg"/>
    </a>
    <div class="footer-menu">
      <ul>    
        <li>
          <a href="/doxygen_cxx/index.html" class="site-menu-item">C++</a>
        </li>    
        <li>
          <a href="/pydrake/index.html" class="site-menu-item">Python</a>
        </li>
        <li class="github-link">
          <a href="https://github.com/RobotLocomotion/drake" class="site-menu-item">GitHub <img src="/third_party/images/GitHub-Mark-64px.png"/></a>
        </li>
      </ul>
    </div>
  </div>
</footer>
<script type="text/javascript">
searchBox.searchLabel = 'Go to name…';
searchBox.DOMSearchField().placeholder = searchBox.searchLabel;
searchBox.DOMSearchField().value = '';
</script>
</body>
</html>
